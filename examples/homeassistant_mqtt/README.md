# ESP32 + PCA9548A + MQTT + Home Assistant AutoDiscovery

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ–µ–≤–æ–π —Å–∫–µ—Ç—á –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–∞—Ç—á–∏–∫–∞–º–∏ –¥–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ PCA9548A —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ Home Assistant —á–µ—Ä–µ–∑ MQTT.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–∞–≤–ª–µ–Ω–∏—è –≤ Home Assistant:

- **4 –¥–∞—Ç—á–∏–∫–∞ –¥–∞–≤–ª–µ–Ω–∏—è** —á–µ—Ä–µ–∑ PCA9548A –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–æ—Ä
- **MQTT** –¥–ª—è —Å–≤—è–∑–∏ —Å Home Assistant
- **AutoDiscovery** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ Home Assistant
- **Availability tracking** ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞
- **Overpressure detection** ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
- **OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ –ø–æ –≤–æ–∑–¥—É—Ö—É
- **Reboot button** ‚Äî –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Home Assistant

## üîß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### MQTT —Ç–æ–ø–∏–∫–∏

#### –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (Device)
- `sanshkaf/status` ‚Äî LWT (Last Will and Testament) —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: `online`/`offline`
- `sanshkaf/pca9548a_ok` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ PCA9548A: `ON`/`OFF` (retained)

#### –î–∞—Ç—á–∏–∫–∏ (–ø–æ –∫–∞–∂–¥–æ–º—É –¥–∞—Ç—á–∏–∫—É)
- `sanshkaf/<name>/status` ‚Äî —Å—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞: `online`/`offline` (retained)
- `sanshkaf/<name>/pressure` ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞—Ä–∞—Ö (2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π, retained)
- `sanshkaf/<name>/temperature` ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ ¬∞C (1 –∑–Ω–∞–∫ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π, retained)
- `sanshkaf/<name>/overpressure` ‚Äî –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞: `ON`/`OFF` (retained)

#### –ö–æ–º–∞–Ω–¥—ã
- `sanshkaf/command/reboot` ‚Äî –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (payload: `PRESS`)

### Availability (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—É—â–Ω–æ—Å—Ç–µ–π)

–ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å (pressure, temperature, overpressure) –∏–º–µ–µ—Ç —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É availability:

1. **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω** ‚Äî `sanshkaf/status` = `online`
2. **PCA9548A —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Äî `sanshkaf/pca9548a_ok` = `ON`
3. **–î–∞—Ç—á–∏–∫ –æ–Ω–ª–∞–π–Ω** ‚Äî `sanshkaf/<name>/status` = `online`

–°—É—â–Ω–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ **–≤—Å–µ —Ç—Ä–∏ —É—Å–ª–æ–≤–∏—è** –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (`availability_mode: all`).

### Home Assistant AutoDiscovery

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É —Å–∫–µ—Ç—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Home Assistant:

- **Binary Sensor**: PCA9548A OK (device_class: connectivity)
- **Sensor**: –î–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞ (device_class: pressure, unit: bar)
- **Sensor**: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞ (device_class: temperature, unit: ¬∞C)
- **Binary Sensor**: –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞ (device_class: problem)
- **Button**: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Home Assistant –∫–∞–∫ –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º:

- **–í–∫–ª—é—á–µ–Ω–∏–µ**: –¥–∞–≤–ª–µ–Ω–∏–µ ‚â• 8.0 bar
- **–í—ã–∫–ª—é—á–µ–Ω–∏–µ**: –¥–∞–≤–ª–µ–Ω–∏–µ ‚â§ 7.6 bar

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–¥—Ä–µ–±–µ–∑–≥" –ø—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è—Ö –æ–∫–æ–ª–æ –ø–æ—Ä–æ–≥–∞.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞—Ç—á–∏–∫–æ–≤

–í –º–∞—Å—Å–∏–≤–µ `SENSORS` –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –¥–∞—Ç—á–∏–∫–∏:

```cpp
static const SensorDef SENSORS[] = {
  {1, "cold_top",    3},  // –∫–∞–Ω–∞–ª PCA, –∏–º—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —á—Ç–µ–Ω–∏—è
  {2, "cold_bottom", 3},
  {3, "hot_top",     6},
  {4, "hot_bottom",  6},
};
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Wi-Fi

```cpp
static const char* WIFI_SSID = "MyWiFi";
static const char* WIFI_PASS = "pass_from_MyWiFi";
```

### MQTT

```cpp
static const char* MQTT_HOST = "10.0.0.10";
static const uint16_t MQTT_PORT = 1883;
static const char* MQTT_USER = "sanshkaf";
static const char* MQTT_PASS = "sanshkafsanshkaf";
```

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã

```cpp
static const char* NODE_ID  = "sanshkaf";        // ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ MQTT
static const char* HOSTNAME = "esp32-sanshkaf";  // Hostname –¥–ª—è OTA –∏ mDNS
```

### OTA

```cpp
static const char* OTA_PASS = "123456";  // –ü–∞—Ä–æ–ª—å –¥–ª—è OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
```

### –¢–∞–π–º–∏–Ω–≥–∏

```cpp
static const uint32_t SAMPLE_PERIOD_MS = 250;  // –ü–µ—Ä–∏–æ–¥ –æ–ø—Ä–æ—Å–∞ (4 Hz)
static const uint32_t SENSOR_OFFLINE_MS = 5000;  // –¢–∞–π–º–∞—É—Ç offline –¥–∞—Ç—á–∏–∫–∞
static const uint32_t PCA_CHECK_MS = 2000;  // –ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ PCA9548A
```

### –ü–æ—Ä–æ–≥–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

```cpp
static const float OVERP_ON_BAR  = 8.0f;   // –í–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
static const float OVERP_OFF_BAR = 7.6f;   // –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
```

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ Arduino Library Manager:

- **WiFi** (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤ ESP32)
- **PubSubClient** ‚Äî MQTT –∫–ª–∏–µ–Ω—Ç
- **ArduinoOTA** ‚Äî OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **ESPmDNS** ‚Äî mDNS –¥–ª—è OTA

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ (WiFi, MQTT, –¥–∞—Ç—á–∏–∫–∏)

2. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–µ—Ç—á** –≤ ESP32

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**:
   - ESP32 –¥–æ–ª–∂–µ–Ω –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WiFi
   - –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
   - –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å AutoDiscovery –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

4. **–í Home Assistant**:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–ª—É–∂–±—ã**
   - –ù–∞–π–¥–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ `sanshkaf`
   - –í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

5. **OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
   - –í Arduino IDE: **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Üí –ü–æ—Ä—Ç** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ `esp32-sanshkaf.local`
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ IP –∞–¥—Ä–µ—Å ESP32

## üìä –°–∫—Ä–∏–Ω—à–æ—Ç—ã

### MQTT Explorer

![MQTT Explorer](2026-01-09_22-45-00.png)

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É MQTT —Ç–æ–ø–∏–∫–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏—è.

### –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ Home Assistant

![Home Assistant Device](2026-01-09_22-46-36.png)

–í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ AutoDiscovery.

### UI –≤ Home Assistant

![Home Assistant UI](2026-01-09_22-47-09.png)

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–≤–ª–µ–Ω–∏–∏ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –°—Ç–∞–±–∏–ª—å–Ω—ã–π Client ID

Client ID —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ MAC-–∞–¥—Ä–µ—Å–∞ ESP32 –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```cpp
mqttClientId = "esp32-sanshkaf-XX:XX:XX:XX:XX:XX"
```

### Retained —Å–æ–æ–±—â–µ–Ω–∏—è

–í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º `retained`, —á—Ç–æ–±—ã Home Assistant –ø–æ–ª—É—á–∞–ª –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.

### Debounce –¥–ª—è PCA9548A

–°–æ—Å—Ç–æ—è–Ω–∏–µ PCA9548A –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å debounce (3 —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥—Ä—è–¥) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π.

### –¢–∞–π–º–∞—É—Ç—ã –¥–∞—Ç—á–∏–∫–æ–≤

–ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –±–æ–ª–µ–µ 5 —Å–µ–∫—É–Ω–¥, –æ–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `offline`.

### Graceful disconnect

–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–µ–∑ MQTT –∫–æ–º–∞–Ω–¥—É —Å–∫–µ—Ç—á –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –æ—Ç –±—Ä–æ–∫–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª LWT.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–µ—Ç–æ—á–Ω–∞—è** ‚Äî —Å–º. [–æ–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞](../direct_connection/README.md#6-Ô∏è-—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞--–æ—á–µ–Ω—å-–Ω–µ—Ç–æ—á–Ω–∞—è-–≤–∞–∂–Ω–æ)
2. **–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ ‚âà 4-5 –ì—Ü (–∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞)
3. **Retry –ª–æ–≥–∏–∫–∞** ‚Äî –∫–∞–∂–¥—ã–π –¥–∞—Ç—á–∏–∫ –∏–º–µ–µ—Ç —Å–≤–æ—ë –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —á—Ç–µ–Ω–∏—è (3 –∏–ª–∏ 6)
4. **Availability** ‚Äî —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –µ—Å–ª–∏ –ª—é–±–æ–µ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

## üîó –°–º. —Ç–∞–∫–∂–µ

- [–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞](../direct_connection/README.md) ‚Äî –æ—Å–Ω–æ–≤—ã —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç—á–∏–∫–æ–º
- [–†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ PCA9548A](../pca9548a_multiplexer/README.md) ‚Äî –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–æ—Ä–æ–º
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è](../../docs/manufacturer/) ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ.

